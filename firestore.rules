rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn()   { return request.auth != null; }
    function roleOf(uid)  { return get(/databases/$(database)/documents/users/$(uid)).data.role; }
    function isAdmin()    { return signedIn() && roleOf(request.auth.uid) == "admin"; }

    // USERS
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn() && request.auth.uid == uid;
      allow update, delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
    }

    // EVENTS (única colección)
    match /events/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      // (opcional) permitir a estudiantes tocar registeredStudents ±1
      allow update: if signedIn()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['registeredStudents'])
        && request.resource.data.maxSpots == resource.data.maxSpots
        && request.resource.data.status   == resource.data.status
        && request.resource.data.date     == resource.data.date
        && request.resource.data.startTime== resource.data.startTime
        && request.resource.data.endTime  == resource.data.endTime
        && request.resource.data.location == resource.data.location
        && request.resource.data.registeredStudents >= 0
        && request.resource.data.registeredStudents <= resource.data.maxSpots
        && (
          request.resource.data.registeredStudents == resource.data.registeredStudents + 1 ||
          request.resource.data.registeredStudents == resource.data.registeredStudents - 1
        );
    }

    // CITAS (deja tu bloque actual tal cual)
    match /citas/{citaId} {
      allow read: if signedIn();
      // … tus reglas actuales para create/update/delete …
    }

    // Bloquear completamente la legacy:
    match /eventos/{id} {
      allow read, write: if false;
    }
  }
}
