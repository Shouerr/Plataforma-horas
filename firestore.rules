rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function roleOf(uid) { return get(/databases/$(database)/documents/users/$(uid)).data.role; }
    function isAdmin()  { return signedIn() && roleOf(request.auth.uid) == "admin"; }

    /* ---------------- USERS ---------------- */
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn() && request.auth.uid == uid;
      allow update, delete: if isAdmin() || (signedIn() && request.auth.uid == uid);
    }

    /* ---------------- EVENTS (colección única) ---------------- */
    match /events/{id} {
      // Leer: público (o cámbialo a signedIn() si prefieres)
      allow read: if true;

      // Admin puede crear/actualizar/eliminar
      allow create, update, delete: if isAdmin();

      // (opcional) Estudiante puede tocar solo registeredStudents ±1
      allow update: if signedIn()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['registeredStudents'])
        && request.resource.data.maxSpots == resource.data.maxSpots
        && request.resource.data.status   == resource.data.status
        && request.resource.data.date     == resource.data.date
        && request.resource.data.startTime== resource.data.startTime
        && request.resource.data.endTime  == resource.data.endTime
        && request.resource.data.location == resource.data.location
        && request.resource.data.registeredStudents >= 0
        && request.resource.data.registeredStudents <= resource.data.maxSpots
        && (
          request.resource.data.registeredStudents == resource.data.registeredStudents + 1 ||
          request.resource.data.registeredStudents == resource.data.registeredStudents - 1
        );
    }

    /* ---------------- CITAS ----------------
       - Admin: CRUD total (para cascada desde el panel)
       - Estudiante: CRUD restringido a sus propias citas
    ------------------------------------------------------------ */
    match /citas/{citaId} {
      allow read: if signedIn();

      // Admin (necesario para delete en cascada)
      allow create, update, delete: if isAdmin();

      // Propietario puede crear/leer/actualizar/cancelar su cita
      allow create: if signedIn()
        && (request.resource.data.userId == request.auth.uid
            || request.resource.data.usuarioId == request.auth.uid);

      allow update: if signedIn()
        && (resource.data.userId == request.auth.uid
            || resource.data.usuarioId == request.auth.uid);

      allow delete: if signedIn()
        && (resource.data.userId == request.auth.uid
            || resource.data.usuarioId == request.auth.uid);
    }

    /* ---------------- Bloquear legacy ---------------- */
    match /eventos/{id} {
      allow read, write: if false;
    }
  }
}
